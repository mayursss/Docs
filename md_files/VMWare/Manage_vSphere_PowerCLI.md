# Sample Scripts for Managing vSphere with VMware PowerCLI
## 1. Connect to a vCenter ServerSystem
- To run PowerCLI cmdlets on vSphere and perform administration or monitoring tasks, you must establish a connection to an ESXi host or a vCenter Server system.
- You can have more than one connection to the same server. For more information, see Managing Default Server Connections.
- If your login credentials contain non-alphanumeric characters, you might need to escape them.
``` powershell
Connect-VIServer -Server esx3.example.com -Protocol http -User 'MyAdministratorUser' -Password 'MyPassword'
```
## 2. Manage Virtual Machines on vSphere
- With PowerCLI, you can automate various administration tasks on virtual machines, for example retrieving information, shutting down and powering off virtual machines.
``` powershell
# View all virtual machines on the target system.
Get-VM
#	Save the name and the power state properties of the virtual machines in the ResourcePool resource pool into a file named myVMProperties.txt.
$respool = Get-ResourcePool ResourcePool
Get-VM -Location $respool | Select-Object Name, PowerState > myVMProperties.txt
# Start the VM virtual machine.
Get-VM VM | Start-VM
# Get information of the guest OS of the VM virtual machine.
Get-VMGuest VM | Format-Custom
# Shut down the OS of the VM virtual machine.
Stop-VMGuest VM
# Power off the VM virtual machine.
Stop-VM VM
# Move the virtual machine VM from the Host01 host to the Host02 host.
Get-VM -Name VM -Location Host01 | Move-VM –Destination Host02
```
> **Note**
>
>If the virtual machine you want to move across hosts is powered on, it must be located on a shared storage registered as a datastore on both the original and the new host.

## 3. Add a Standalone Host to a vCenter Server System
- You can add standalone hosts to a vCenter Server system by using the `Add-VMHost` cmdlet. After adding the hosts, you will be able to manage them through the vCenter Server system.
``` powershell
# View all hosts on the vCenter Server system that you have established a connection with.
Get-VMHost
# Add the Host standalone host.
Add-VMHost -Name Host -Location (Get-Datacenter DC) -User root -Password pass
```
## 4. Set the License Key for a Host on vCenter Server
- You can set the license key for a host on a vCenter Server system by using the LicenseKey parameter of the `Set-VMHost` cmdlet.
Set the host to evaluation mode or provide a valid license key.
``` powershell
# Save the Host host object as a variable.
$vmhost = Get-VMHost -Name Host
# Set the host to evaluation mode by providing the evaluation key.
Set-VMHost -VMHost $vmhost -LicenseKey 00000-00000-00000-00000-00000
# Provide a valid license key
Set-VMHost -VMHost $vmhost -LicenseKey "Your_license_key"
```

## 5. Activate Maintenance Mode for a Host on vCenter Server
- To complete some specific administration tasks, you might need to activate maintenance mode for a host. On vCenter Server, you can activate maintenance mode by using the Set-VMHost cmdlet.
``` powershell
# Save the Host host object as a variable.
$vmhost = Get-VMHost -Name Host
# Get the cluster to which Host belongs and save the cluster object as a variable.
$vmhostCluster = Get-Cluster -VMHost $vmhost
# Start a task that activates maintenance mode for the "Host" host and save the task object as a variable.
$updateHostTask = Set-VMHost -VMHost $vmhost -State "Maintenance" -RunAsync
# Get and apply the recommendations generated by DRS.
Get-DrsRecommendation -Cluster $vmhostCluster | where {$_.Reason -eq "Host is entering maintenance mode"} | Invoke-DrsRecommendation
# Get the task output object and save it as a variable.
$myUpdatedHost = Wait-Task $updateHostTask
```
>**Note**
>
>If the host is not automated or is partially automated and has powered-on virtual machines running on it, you must use the RunAsync parameter and wait until all powered-on virtual machines are relocated or powered off before applying DRS recommendations.

## 6. Create vSphere Inventory Objects
- By using PowerCLI cmdlets, you can automate creating different inventory objects on vSphere.
``` powershell
# Get the inventory root folder and create a new folder named Folder in it.
$folder = Get-Folder -NoRecursion | New-Folder -Name Folder
# Create a new data center named DC in the Folder folder.
New-Datacenter -Location $folder -Name DC
# Create a folder named Folder1 under DC.
Get-Datacenter DC | New-Folder -Name Folder1
$folder1 = Get-Folder -Name Folder1
# Create a new cluster Cluster1 in the Folder1 folder.
New-Cluster -Location $folder1 -Name Cluster1 -DrsEnabled -DrsAutomationLevel FullyAutomated
# Distributed Resource Scheduler (DRS) is a feature that provides automatic allocation of cluster resources.
# Add a host in the cluster by using the Add-VMHost command, and provide credentials when prompted.
$vmhost1 = Add-VMHost -Name 10.23.112.345 -Location (Get-Cluster Cluster1)
# Create a resource pool in the root resource pool of the cluster.
$myClusterRootRP = Get-Cluster Cluster1 | Get-ResourcePool -Name Resources
New-ResourcePool -Location $myClusterRootRP `
    -Name MyRP01 `
    -CpuExpandableReservation $true `
    -CpuReservationMhz 500 `
    -CpuSharesLevel high `
    -MemExpandableReservation $true `
    -MemReservationGB 1 `
    -MemSharesLevel high
# Create a virtual machine asynchronously.
$vmCreationTask = New-VM -Name VM2 -VMHost $vmhost1 -ResourcePool MyRP01 -DiskGB 100 -MemoryGB 2 -RunAsync
# The RunAsync parameter indicates that the command runs asynchronously. This means that in contrast to a synchronous
# operation, you do not have to wait for the process to complete before supplying the next command at the command line.
```

## 7. Create Virtual Machines on vCenter Server Using an XML Specification File
- You can use a specification provided in an XML file to automate the creation of virtual machines on vCenter Server.
- The myVM.xml file must be present with the following content:
```
<CreateVM>
<VM>
<Name>MyVM1</Name>
<HDDCapacity>100</HDDCapacity>
</VM>
<VM>
<Name>MyVM2</Name>
<HDDCapacity>100</HDDCapacity>
</VM>
</CreateVM>
```
``` powershell
# Read the content of the myVM.xml file.
[xml]$s = Get-Content myVM.xml
# get VM host
$vmhost1 = Get-VMHost -Name Host
# create the virtual machines.
$s.CreateVM.VM | foreach {New-VM -VMHost $vmHost1 -Name $_.Name -DiskGB $_.HDDCapacity}
```

## 8. Manage Virtual Machine Templates on vCenter Server
- You can use PowerCLI to create virtual machines templates and convert them to virtual machines on vCenter Server.
- A virtual machine template is a reusable image created from a virtual machine. The template, as a derivative of the source virtual machine, includes virtual hardware components, an installed guest operating system, and software applications.
``` powershell
# Create a template from the VM1 virtual machine.
New-Template -VM VM1 -Name VM1Template -Location (Get-Datacenter DC )
# Convert the VM1Template template for use by a virtual machine named VM3.
Get-Template VM1Template | Set-Template -ToVM -Name VM3
# Create a template from the VM2 virtual machine.
New-Template -VM VM2 -Name VM2Template -Location (Get-Datacenter DC )
# Convert the VM2Template template to a virtual machine named VM4.
Get-Template VM2Template | Set-Template -ToVM -Name VM4
# Convert the VM4 virtual machine to a template.
Set-VM –VM VM4 –ToTemplate –Name “VM4Template”
# Create a template called VM3Template by cloning VM2Template.
Get-Template VM2Template | New-Template -Name VM3Template –VMHost $targetVMHost
```

## 9. Create and Use Snapshots on vCenter Server
- You can use the Snapshot parameter of Get-VM to take a snapshot of virtual machines and then revert the states of the virtual machines back to the snapshot.
- A snapshot captures the memory, disk, and settings state of a virtual machine at a particular moment. When you revert to a snapshot, you return all these items to the state they were in at the time you took that snapshot.
``` powershell
# Take a snapshot of all virtual machines in the MyRP01 resource pool.
Get-ResourcePool MyRP01 | Get-VM | New-Snapshot -Name InitialSnapshot
# Revert all virtual machines in the MyRP01 resource pool to the InitialSnapshot snapshot.
$VMs = Get-ResourcePool MyRP01 | Get-VM
foreach( $vm in $VMs ) { Set-VM -VM $vm –Snapshot InitialSnapshot }
```
>**Note**
>
> The Location parameter takes arguments of the VIContainer type, on which Cluster, Datacenter, Folder, ResourcePool, and
 VMHost object types are based. Therefore, the Location parameter can use arguments of all these types.

## 10. Update the Resource Configuration Settings of a Virtual Machine on vCenter Server
- You can use the `Set-VMResourceConfiguration` cmdlet to modify the resource configuration properties of a virtual machine, including memory, CPU shares, and other settings.
``` powershell
# View the resource configuration for the VM1 virtual machine.
Get-VMResourceConfiguration -VM VM1
# View the disk share of the VM1 virtual machine.
Get-VMResourceConfiguration -VM VM1 | Format-Custom -Property DiskResourceConfiguration
# Change the memory share of the VM1 virtual machine to low.
Get-VM VM1 | Get-VMResourceConfiguration | Set-VMResourceConfiguration -MemSharesLevel low
# Change the CPU shares of the VM1 virtual machine to high.
Get-VM VM1 | Get-VMResourceConfiguration | Set-VMResourceConfiguration -CpuSharesLevel high
# Change the disk share of the VM1 virtual machine to 100.
$vm1 = Get-VM VM1
$vm1disk = Get-HardDisk $vm1
Get-VMResourceConfiguration $vm1 | Set-VMResourceConfiguration -Disk $vm1disk -DiskSharesLevel custom -NumDiskShares 100
```
